---
title: "Mapa de calor (2D Density)"
subtitle: "Mapa de calor utilizando las incidencias delictivas a nivel municipal"
author: "Diana Villasana Ocampo"
knit: (function(inputFile, encoding) {
       rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Output/")
  })
output:
   html_document:
      code_folding: hide
      highlight: tango
      theme: flatly
      toc: true
      toc_depth: 3
      toc_float:
        collapsed: yes
---

```{=html}
<style type="text/css">
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #1C3BA4
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li>a:focus {
    color: #ffffff;
    background-color: #09C2BC
}
</style>
```

```{=html}
<style>
.tile1-text {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A6A87;
    list-style: none;
}
.top1-tiles a:nth-of-type(1):hover, .top-tiles1 a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6A87
}
</style>
```

```{=html}
<style>
.tile2-text {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A6CC8;
    list-style: none;
}
.top2-tiles a:nth-of-type(1):hover, .top2-tiles a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6CC8
}
</style>
```

```{=html}
<style>
.math {
  font-size: 15px;
  color: #B6854D;
}
</style>
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE, 
                      cache.lazy = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
```

```{r,echo=FALSE, eval=FALSE}
rm(list = ls())
```

```{r, echo = FALSE, results=FALSE}
# Paquetes que se usaron en el documento 
require(dplyr)          #A Grammar of Data Manipulation 
require(ggplot2)        # Generar gr√°ficos ggplot y la geometr√≠a de un mapa
require(RColorBrewer)
require(ggspatial)
require(ggpubr)
require(knitr)
require(kableExtra)
require(openxlsx)
require(readxl)
require(rgdal)          #Para importar shapefiles. 
require(sp)             # Classes and Methos for Spatial Data
library(spdep)    # √çndice de Moran 
require(spdplyr)        #Data manipulation verbs for the sptial classes
require(stringr)
require(tidyverse) 
require(unikn)          # Paleta de colores
```

```{r, echo = FALSE, results=FALSE}
# Se descargan las fuentes de la google fonts
require(showtext)
# activar showtext
showtext_auto()
font_add_google("Montserrat", "montserrat")
```

```{r, echo = FALSE, fig.height=4, fig.width=6, fig.align='center'}
require(ggplot2)
require(ggpubr)
v <- ggplot(faithfuld, aes(waiting, eruptions, z = density)) + 
      geom_contour(aes(colour = after_stat(level)), binwidth = 0.001) +
       theme_transparent() + 
        theme(legend.position = 'none') + 
         scale_color_viridis_c()

v
```


## Objetivo  

Los **contornos de una estimaci√≥n de densidad en 2D** (`Contours of a 2D density estimate`) son una herramienta fundamental para la visualizaci√≥n estad√≠stica, permitiendo representar gr√°ficamente la distribuci√≥n de variables bidimensionales en un espacio de coordenadas. 

Su principal funci√≥n consiste en mostrar la concentraci√≥n de puntos en conjuntos de datos bidimensionales, lo que resulta particularmente √∫til cuando se trabaja con grandes vol√∫menes de informaci√≥n. Estos contornos facilitan la identificaci√≥n de √°reas con mayor densidad de observaciones en gr√°ficos de dispersi√≥n, solucionando el problema de visualizaci√≥n que surge cuando hay numerosos puntos solapados. 

Adem√°s de visualizar distribuciones, estos contornos permiten detectar patrones y estructuras subyacentes en los datos, revelando agrupaciones naturales y la forma general de la distribuci√≥n, ya sea unimodal, multimodal o con otras caracter√≠sticas distintivas. Una ventaja adicional es su capacidad para facilitar la comparaci√≥n entre diferentes subconjuntos de datos, permitiendo superponer contornos en gr√°ficos para analizar diferencias entre distintos grupos o categor√≠as. 

### **üìå Usos principales de los contornos de densidad en 2D para datos de homicidios:**
  
1. **üìç Identificaci√≥n de zonas con alta incidencia de homicidios**  
- Permiten encontrar **"hotspots"** o zonas donde los homicidios son m√°s frecuentes.  
- √ötil para la **toma de decisiones en seguridad p√∫blica** y asignaci√≥n de recursos policiales.  

2. **‚è≥ An√°lisis temporal y espacial**  
- Si se usa con **coordenadas geogr√°ficas** (latitud y longitud), los contornos mostrar√°n las √°reas m√°s afectadas.  
- Si se usa con **fechas y horas**, se pueden detectar periodos del d√≠a o del a√±o con mayor incidencia.  

3. **üïµÔ∏è‚Äç‚ôÇÔ∏è Detecci√≥n de patrones y tendencias criminales**  
- Ayuda a identificar si los homicidios siguen una distribuci√≥n aleatoria o si hay **patrones estructurados**.  
- Se puede comparar la densidad en diferentes a√±os para analizar la evoluci√≥n del crimen en el tiempo.  

4. **‚öñÔ∏è Comparaci√≥n de diferentes regiones o tipos de homicidios**  
- Permite superponer los contornos de densidad de diferentes tipos de homicidios (por arma de fuego, por arma blanca, etc.)  
- Se pueden comparar ciudades o regiones para ver d√≥nde es m√°s grave el problema.   

## Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica (`SESNSP`)   

El Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica ([`SESNSP`](https://www.gob.mx/sesnsp)) es una instituci√≥n clave en M√©xico, encargada de coordinar y ejecutar las pol√≠ticas p√∫blicas en materia de seguridad p√∫blica. Su objetivo principal es fortalecer la seguridad en todo el pa√≠s, trabajando en colaboraci√≥n con los tres niveles de gobierno (federal, estatal y municipal).

Las funciones m√°s importantes del `SESNSP`:

* **Coordinaci√≥n y seguimiento:**
    * El SESNSP act√∫a como eje de coordinaci√≥n entre las diversas instituciones de seguridad p√∫blica, tanto a nivel federal como estatal y municipal.
    * Da seguimiento a los acuerdos y decisiones del Consejo Nacional de Seguridad P√∫blica.
* **Implementaci√≥n de pol√≠ticas p√∫blicas:**
    * Se encarga de dise√±ar e implementar estrategias y programas para prevenir el delito, fortalecer las instituciones de seguridad y mejorar la respuesta ante situaciones de emergencia.
* **Profesionalizaci√≥n y equipamiento:**
    * Promueve la capacitaci√≥n y profesionalizaci√≥n de los cuerpos de seguridad.
    * Impulsa la modernizaci√≥n del equipamiento tecnol√≥gico e infraestructura de las instituciones de seguridad.
* **Informaci√≥n y datos:**
    * Genera y difunde informaci√≥n estad√≠stica sobre incidencia delictiva y otros indicadores relevantes para la seguridad p√∫blica.
    * Proporciona datos para la toma de decisiones en materia de seguridad.
* **Prevenci√≥n del delito:**
    * Promueve la cultura de la paz y la legalidad.
    * Desarrolla programas para la prevenci√≥n social de la violencia y la delincuencia.
* **Participaci√≥n ciudadana:**
    * Fomenta la colaboraci√≥n entre la ciudadan√≠a y las autoridades en materia de seguridad.


### Fuentes de informaci√≥n    

El Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica (SESNSP) recopila y publica informaci√≥n sobre incidencia delictiva a trav√©s de un proceso sistem√°tico y riguroso que involucra a diversas fuentes oficiales y metodolog√≠as estad√≠sticas estandarizadas. Esta instituci√≥n gubernamental se encarga de centralizar, procesar y difundir los datos relacionados con la seguridad p√∫blica en todo el territorio mexicano, proporcionando as√≠ una visi√≥n integral de la situaci√≥n delictiva en el pa√≠s. Aqu√≠ te explico detalladamente c√≥mo llevan a cabo este importante proceso de recolecci√≥n y publicaci√≥n de informaci√≥n:

- **Fiscal√≠as y Procuradur√≠as:**
    - Las fiscal√≠as generales de los estados y la Fiscal√≠a General de la Rep√∫blica (FGR) proporcionan los datos detallados y sistem√°ticos sobre los delitos registrados en sus investigaciones, constituyendo una de las principales fuentes de informaci√≥n estad√≠stica a nivel nacional.
    - Esta informaci√≥n abarca tanto las averiguaciones previas del sistema tradicional como las carpetas de investigaci√≥n iniciadas bajo el nuevo sistema de justicia penal acusatorio, lo que permite una visi√≥n completa del panorama delictivo documentado oficialmente.
- **Registros administrativos:**
    - El SESNSP tambi√©n utiliza y analiza datos provenientes de diversos registros administrativos de otras instituciones gubernamentales, como las corporaciones policiales estatales y municipales, as√≠ como los centros de atenci√≥n de llamadas de emergencia (911), que complementan la informaci√≥n obtenida de las fiscal√≠as para ofrecer un panorama m√°s integral de la situaci√≥n delictiva. 
    
    
### Metodolog√≠a:   

- **Registro de delitos:**
    - La incidencia delictiva se refiere espec√≠ficamente a la presunta ocurrencia de delitos formalmente registrados en las investigaciones oficiales, siguiendo protocolos estandarizados que permiten la comparabilidad de los datos a nivel nacional e internacional.
    - El SESNSP clasifica meticulosamente los delitos en diferentes categor√≠as y subcategor√≠as, tanto del fuero com√∫n como del fuero federal, utilizando criterios uniformes que facilitan el an√°lisis estad√≠stico y la identificaci√≥n de patrones delictivos en diferentes regiones del pa√≠s. 
    
    
- **Publicaci√≥n de datos:**
    - El SESNSP publica peri√≥dicamente los datos compilados de incidencia delictiva en su sitio web oficial, a trav√©s de informes mensuales detallados y compendios anuales que permiten visualizar tendencias y comportamientos delictivos a lo largo del tiempo.
    - Tambi√©n proporciona acceso a bases de datos abiertos en formatos compatibles con diferentes programas estad√≠sticos para que la ciudadan√≠a, investigadores, organizaciones civiles y otras instituciones gubernamentales puedan acceder, descargar y analizar la informaci√≥n de acuerdo con sus necesidades espec√≠ficas.
    - En su p√°gina oficial se pueden encontrar los datos desagregados por estado, municipio y regi√≥n geogr√°fica, y tambi√©n se puede consultar informaci√≥n especializada sobre delitos federales y comunes, incluyendo variables como modalidad, tipo de delito, bienes jur√≠dicos afectados y caracter√≠sticas demogr√°ficas generales. 
    
### Tipos de delitos 

La diferencia fundamental est√° en el bien jur√≠dico protegido: en el fuero com√∫n, se protege a los ciudadanos individualmente, salvaguardando sus derechos personales y patrimoniales dentro del √°mbito local; en el fuero federal, se protege a la naci√≥n como entidad soberana, incluyendo sus instituciones, la seguridad nacional y el orden constitucional.   

Algunos delitos pueden ser del fuero com√∫n o federal dependiendo de las circunstancias espec√≠ficas del caso, como la participaci√≥n de funcionarios federales, el lugar donde se comete el delito (si ocurre en instalaciones federales), la naturaleza transnacional del mismo, o si afecta bienes o recursos que son propiedad o est√°n bajo administraci√≥n federal.   

**Delitos del Fuero Com√∫n:**: Son aquellos que afectan directamente a los ciudadanos en su vida cotidiana. Est√°n tipificados en los c√≥digos penales de cada estado.   

- **Ejemplos**:
    - Robo (a casa habitaci√≥n, a transe√∫ntes, de veh√≠culos)
    - Homicidio
    - Lesiones
    - Violencia familiar
    - Delitos sexuales
- **Jurisdicci√≥n**: Son investigados y juzgados por las autoridades de los estados.

**Delitos del Fuero Federal:**: Son aquellos que afectan a la Federaci√≥n, es decir, a la naci√≥n en su conjunto. Est√°n tipificados en el C√≥digo Penal Federal y otras leyes federales.  

- **Ejemplos**:
    - Delitos contra la salud (narcotr√°fico)
    - Delitos fiscales (evasi√≥n de impuestos)
    - Delitos electorales
    - Delitos contra la seguridad de la naci√≥n (terrorismo)
    - Delitos cometidos en instalaciones federales.
    - Delitos que involucran a funcionarios federales.    
    
**Jurisdicci√≥n**: Son investigados y juzgados por las autoridades federales (Fiscal√≠a General de la Rep√∫blica).


```{r, eval = FALSE}
df <- read.csv(file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.csv"), 
               header = TRUE,
               encoding = "latin1") %>% 
       rename("CVE_ENT" = "Clave_Ent",
              "CVE_MUN" = "Cve..Municipio") %>%
       mutate(CVE_ENT = str_pad(.$CVE_ENT, width = 2, side = "left", pad = "0"),
              CVE_MUN = str_pad(.$CVE_MUN, width = 5, side = "left", pad = "0"))

```



```{r, echo = FALSE}
#save(df, file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.RData"))
load(file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.RData"))
```

```{r, echo = FALSE}
require(gt)

head(df, 10) %>% 
 gt() %>%
  tab_header(title = "Reportes de incidencia delictiva a nivel municipal",
             subtitle = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
       cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(180),
                  starts_with("Modalidad") ~ px(180),
                  everything() ~ px(100)) %>%
          as_raw_html()
```

<br>


Se suman las columnas de enero hasta diciembre para tener los totales por los diferentes bienes juridicos, tipo de delito, subtipo y modalidad a nivel municipal.  

Por otro lado para fines practicos, se va a trabajar con el a√±o 2024. Para analizar la distribuci√≥n de los datos de manera espacial. 

```{r}
df <- df %>% 
         mutate(Total = rowSums(.[,10:21], na.rm = TRUE)) %>% 
          filter(A√±o %in% "2024")
```

Analicemos como se conforma la base de datos 

**Bien jur√≠dico afectado**  

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Bien.jur√≠dico.afectado) %>% 
           summarise(Total = sum(Total, na.rm = TRUE))

tabla %>% 
 gt() %>%
  tab_header(title = "Bien jur√≠dico afectado",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(280),
                 starts_with("Modalidad") ~ px(320),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Bien.jur√≠dico.afectado = md("**Bien jur√≠dico afectado**")) %>% 
          as_raw_html()
```


**Tipo de delito**   

Se muestran las primeras 10 categor√≠as y de mayor denominaci√≥n de la categor√≠a **tipo de delito**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Tipo.de.delito) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Tipo de delito",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(200),
                 starts_with("Tipo.") ~ px(380),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Tipo.de.delito = md("**Tipo de delito**")) %>% 
          as_raw_html()
```

**Subtipo de delito**  

Se muestran las primeras 10 categor√≠as y de mayor denominaci√≥n de la categor√≠a **subtipo de delito**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Subtipo.de.delito) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Subtipo de delito",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(200),
                 starts_with("Subtipo.") ~ px(420),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Subtipo.de.delito = md("**Subtipo de delito**")) %>% 
          as_raw_html()
```


**Modalidad**  

Se muestran las primeras 10 categor√≠as y de mayor denominaci√≥n de la categor√≠a **modalidad**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Modalidad) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Modalidad",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(200),
                 starts_with("Modalidad") ~ px(420),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Modalidad = md("**Modalidad**")) %>% 
          as_raw_html()
```


## Homicidios dolososos    

Un homicidio doloso se define como la privaci√≥n de la vida de una persona, donde existe la intenci√≥n deliberada de causar la muerte. 

Para obtener informaci√≥n m√°s precisa y actualizada, te recomiendo consultar las siguientes fuentes:
  
* P√°gina oficial del [SESNSP](https://www.gob.mx/sesnsp/acciones-y-programas/datos-abiertos-de-incidencia-delictiva?state=published).
* Informes del [INEGI](https://www.inegi.org.mx/temas/mortalidad/).  


```{r}
homicidios <- df %>% 
               filter(Tipo.de.delito %in% "Homicidio")  %>% 
                group_by(CVE_MUN) %>% 
                 summarise(Total = sum(Total, na.rm = TRUE))
```

A continuaci√≥n, se presentan los primeros 10 estados con mayor n√∫mero de incidencias delictiva (`Homicidios dolosos`).  

```{r, echo = FALSE}
require(gt)

df %>% 
 filter(Tipo.de.delito %in% "Homicidio")  %>% 
  group_by(Entidad) %>% 
   summarise(Total = sum(Total, na.rm = TRUE))%>% 
    arrange(desc(Total)) %>% 
     head(. , 15) %>%
      gt() %>%
       tab_header(title = "Reportes de incidencia homicidios a nivel municipal",
                  subtitle = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica") %>%
        tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica | 20 de febrero de 2025") %>%
        tab_options(heading.title.font.size = 14, 
                    heading.subtitle.font.size = 12,
                    table.font.names = "Century Gothic",
                    table.font.size = 10,
                    table.align = 'center',
                    data_row.padding = px(1)) %>%
         tab_style(style = list(cell_text(align = "left", 
                                          weight = 'bold')),
                    locations = list(cells_title(groups = c("title")))) %>%
          tab_style(style = list(cell_text(align = "left")),
                    locations = list(cells_title(groups = c("subtitle")))) %>%
            cols_width(starts_with("Bien.jur√≠dico.afectado") ~ px(180),
                       starts_with("Modalidad") ~ px(180),
                       everything() ~ px(100)) %>%
             as_raw_html()
```


## Marco Geoestad√≠stico Nacional (MGN) 2020

El **Marco Geoestad√≠stico Nacional (MGN) 2020** del **Instituto Nacional de Estad√≠stica y Geograf√≠a (INEGI)** es un sistema de referencia geogr√°fica que define la divisi√≥n territorial de M√©xico para la recopilaci√≥n, an√°lisis y presentaci√≥n de informaci√≥n estad√≠stica. Se utiliza principalmente en censos y encuestas para garantizar la compatibilidad de datos espaciales a nivel nacional.

#### **Caracter√≠sticas principales del MGN 2020:**

1.  **Unidades geogr√°ficas:**
    -   **√Åreas Geoestad√≠sticas Estatales (AGEE):** corresponden a los estados.\
    -   **√Åreas Geoestad√≠sticas Municipales (AGEM):** coinciden con los municipios.\
    -   **√Åreas Geoestad√≠sticas B√°sicas (AGEB):** subdivisiones de los municipios, utilizadas en zonas urbanas y rurales.\
    -   **Manzanas geoestad√≠sticas:** delimitaciones dentro de las AGEB urbanas.
2.  **Proyecci√≥n y sistema de coordenadas:**
    -   Utiliza el **Sistema de Referencia Geod√©sico ITRF2008** en coordenadas geogr√°ficas con el **datum WGS84**.\
    -   Se presenta en formato vectorial compatible con SIG (Sistemas de Informaci√≥n Geogr√°fica), en formatos como **Shapefile (SHP)** y **GeoJSON**.

#### Shapefile

La funci√≥n `readOGR` del paquete `rgdal`, extrae autom√°ticamente la informaci√≥n utilizada por otros paquetes `SIG` de c√≥digo abierto como QGIS y permite a R manejar una gama m√°s amplia de formatos de datos espaciales. Esta funci√≥n lee datos `OGR` y datos vectoriales, pero solamente permite manejar capas con caracter√≠sticas geom√©tricas (no mezcla puntos, l√≠neas o pol√≠gonos en una sola capa) y a su vez establecer√° un sistema de referencia espacial si la capa tiene dichos metadatos.\
Para leer un archivo `shapefile`, se establecen los siguientes argumentos, como `dsn`, en donde se indica el directorio que contiene los shapes y `layer` que es el nombre expl√≠cito de la capa a trabajar y dichas capas deben de ir sin la extensi√≥n `.shp`.

A continuaci√≥n, se lee el archivo .shp que contiene de manera integrada la divisi√≥n de el √°rea geoestad√≠stica municipal `agem`.

```{r,results=FALSE,class.source = "fold-show"}
shape_estados <- readOGR(dsn ="D:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                             layer = "00ent",
                              encoding = "UTF-8",
                               use_iconv = TRUE)
```

```{r,results=FALSE,class.source = "fold-show"}
shape_municipios <- readOGR(dsn ="D:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                             layer = "00mun",
                              encoding = "UTF-8",
                               use_iconv = TRUE)
```

La funci√≥n `rename()` del paquete `dplyr` permite cambiar el nombre de la columna de la clave geoestad√≠stica a nivel estatal dentro de la base de datos del shape.

```{r,class.source = "fold-show"}
shape_municipios@data <- shape_municipios@data %>%
                          rename("CVE_GEO" = "CVEGEO")
```


### SpatialPolygonsData Frame 

Se fusionan los datos del `shape_municipios` con datos estad√≠sticos del √≠ndice de marginaci√≥n a nivel municipal (`IMM_2020`), excluyendo las claves municipales (`CVE_MUN`) y asegurando que `GM_2020` se ordene de acuerdo a los grados de marginaci√≥n. El resultado es `layer_municipios`, un objeto que contiene a los municipios junto con sus atributos actualizados, lo que facilita su an√°lisis y visualizaci√≥n en mapas.

#### $$SpatialPolygons \Rightarrow SpatialPolygons + Datos$$

```{r, class.source = "fold-show"}
layer_municipios <- inner_join(shape_municipios,
                                homicidios,
                                 by = join_by("CVE_GEO" == "CVE_MUN"))
```

## Centroides

La funci√≥n `coordinates()` extrae las coordenadas de los centroides de los pol√≠gonos en $(x,y)$ de la base de datos espacial y la almacenamos en la variable `coords`, para su posterior uso en el c√≥digo.

```{r}
# Extrayendo coordenadas desde la base de datos espaciales.
coords = coordinates(layer_municipios) %>% 
          as.data.frame() %>% 
           rename("lon" = "V1",
                  "lat" = "V2") %>% 
            cbind(layer_municipios@data[, c("CVE_GEO", "CVE_ENT", "Total")])  
```

```{r}
homicidios <- df %>% 
               filter(Subtipo.de.delito %in% "Homicidio doloso") %>% 
                select(CVE_MUN) %>% 
                 left_join(., coords, by = join_by("CVE_MUN" == "CVE_GEO")) %>% 
                  arrange(CVE_MUN) %>% 
                   filter(Total > 0)
```


## Mapa de homicidios  

```{r}
p <- ggplot() + 
      layer_spatial(layer_municipios, aes(fill = Total), color = "transparent") + 
       layer_spatial(shape_estados, fill = "transparent", color = "black") + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          scale_fill_viridis_c(option = "A", begin = 0.3, end = 1, direction = -1) +
           scale_color_manual(values = c("#BDBDBD")) + 
            guides(color = guide_legend(override.aes = list(fill = usecol(pal = pal_petrol, n = 5)))) +
     labs(title = "Mapa coropl√©tico de homicidios dolosos a nivel municipal",
           fill = stringr::str_wrap("Homicidios dolosos", 10), 
            caption = expression(paste("Elaboraci√≥n propia")))
p
```

## 2D Density Map   

```{r}
p <- ggplot() + 
      layer_spatial(shape_estados, fill = "transparent", color = "black") + 
       geom_point(data = coords, aes(x = lon, y = lat, size = Total, color = Total), alpha = 0.6, shape = 21) +
        #stat_density_2d_filled(data = coords, aes(x = lon, y = lat, fill = ..Total..), alpha = 0.6) + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          guides(size = FALSE, alpha = FALSE) + 
          scale_fill_gradientn(colours = rev(brewer.pal(7, "Spectral"))) + 
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral")))

p
```

```{r}
homicidios <- coords %>% 
               filter(Total > 0) %>% 
                uncount(Total)
```


```{r}
values <- colorRampPalette(c("white", "orange", "red"))(10)

p <- ggplot() + 
      layer_spatial(shape_estados, fill = "transparent", color = "black") + 
        stat_density_2d_filled(data = homicidios, aes(x = lon, y = lat, fill = ..level..), alpha = 0.6) + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          guides(size = FALSE, alpha = FALSE) + 
          scale_fill_manual(values = values) + 
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral")))

p
```

```{r}
library(ggplot2)
library(sf)
library(ggspatial)
library(RColorBrewer)

shp_municipios <- st_as_sf(layer_municipios)  

capas_estados <- shape_estados %>%
                  sp::spChFIDs(., str_pad(shape_estados@data$CVEGEO, 2, "left", pad = "0")) %>%
                   fortify(., id = "CVE_GEO")

limites <- capas_estados %>%
            filter(id == c("09", "15", "13")) %>%
             summarise(min.x = min(.$long),
                       max.x = max(.$long),
                       min.y = min(.$lat),
                       max.y = max(.$lat))
 
p <- ggplot() + 
      layer_spatial(shape_municipios, 
                     fill = "transparent", 
                      size = 0.5,
                      color = "#919191") + 
       layer_spatial(shape_estados, 
                      fill = "transparent", 
                       size = 5,
                       color = "black") + 
        geom_point(data = coords, aes(x = lon, y = lat, color = Total, size = Total), alpha = 0.6) +
         stat_density_2d_filled(data = homicidios %>%
                                 filter(CVE_ENT == c("09", "15", "13")), aes(x = lon, y = lat, fill = ..level..), color = "#919191", alpha = 0.6) + 
          theme_bw() + 
           theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
                 plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
                 legend.key.size = unit(0.5, "cm"),
                 legend.text = element_text(size = 12, family = "montserrat"), 
                 legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
                 legend.position = "right"
                 ) + 
          guides(alpha = FALSE, fill = FALSE, color = FALSE) + 
          scale_fill_viridis_d(option = "magma", direction = -1, begin = 0.5, end = 1) +  # Para densidad
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral"))) + 
            coord_sf(xlim = c(limites$min.x, limites$max.x),
                     ylim = c(limites$min.y, limites$max.y)) 

p
```


```{r}
library(ggplot2)
library(sf)
library(ggspatial)
library(RColorBrewer) 
tabla <- homicidios %>% 
          filter(CVE_ENT == "11") 



              
shp_municipios <- st_as_sf(layer_municipios)  

capas_estados <- shape_estados %>%
                  sp::spChFIDs(., str_pad(shape_estados@data$CVEGEO, 2, "left", pad = "0")) %>%
                   fortify(., id = "CVE_GEO")

limites <- capas_estados %>%
            filter(id == c("11")) %>%
             summarise(min.x = min(.$long),
                       max.x = max(.$long),
                       min.y = min(.$lat),
                       max.y = max(.$lat))
 
p <- ggplot() + 
     
         stat_density2d(data = tabla, aes(x = lon, y = lat, fill = stat(level)), geom = "polygon", alpha = 0.4
                        ) + 
   layer_spatial(shape_municipios,
                     fill = "transparent", 
                      size = 0.5,
                      color = "#919191") + 
      
        geom_point(data = coords, aes(x = lon, y = lat, color = Total, size = Total), alpha = 0.6, shape = 21) +
   layer_spatial(shape_estados, 
                      fill = "transparent", 
                       size = 5,
                        color = "black") + 
         # geom_contour_filled(data = coords %>% filter(CVE_ENT == "09"), aes(x = lon, y = lat, z = Total), color = "black", alpha = 0.5) +
           theme_bw() + 
           theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
                 plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
                 legend.key.size = unit(0.5, "cm"),
                 legend.text = element_text(size = 12, family = "montserrat"), 
                 legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
                 legend.position = "right"
                 ) + 
          guides(alpha = FALSE, fill = FALSE, color = FALSE) + 
          scale_fill_viridis_c(option = "magma", direction = 1, begin = 0.5, end = 1) +  # Para densidad
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Blues"))) + 
            coord_sf(xlim = c(limites$min.x, limites$max.x),
                     ylim = c(limites$min.y, limites$max.y)) 


p

```

## Referencias

Secretariado Ejecutivo del Sistema Nacional de Seguridad P√∫blica. (2025). Inicio. Recuperado de: https://www.gob.mx/sesnsp

## Librer√≠as

**Librer√≠as que se usaron en el trabajo** 

```{r, collapse=FALSE}
sesion_info <- devtools::session_info()
```

```{r, echo = FALSE}
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
   kable_classic(full_width = TRUE, html_font = "montserrat", font_size = 10) 
```

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png" alt="Creative Commons Licence" style="border-width:0"/></a><br />This work by [**Diana Villasana Ocampo**]{xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName"} is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.


