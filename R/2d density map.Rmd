---
title: "Mapa de calor (2D Density)"
subtitle: "Mapa de calor utilizando las incidencias delictivas a nivel municipal"
author: "Diana Villasana Ocampo"
knit: (function(inputFile, encoding) {
       rmarkdown::render(inputFile, encoding = encoding, output_dir = "../Output/")
  })
output:
   html_document:
      code_folding: hide
      highlight: tango
      theme: flatly
      toc: true
      toc_depth: 3
      toc_float:
        collapsed: yes
---

```{=html}
<style type="text/css">
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #1C3BA4
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li>a:focus {
    color: #ffffff;
    background-color: #09C2BC
}
</style>
```

```{=html}
<style>
.tile1-text {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A6A87;
    list-style: none;
}
.top1-tiles a:nth-of-type(1):hover, .top-tiles1 a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6A87
}
</style>
```

```{=html}
<style>
.tile2-text {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A6CC8;
    list-style: none;
}
.top2-tiles a:nth-of-type(1):hover, .top2-tiles a:nth-of-type(1):focus{
    color: #ffffff;
    background: #0A6CC8
}
</style>
```

```{=html}
<style>
.math {
  font-size: 15px;
  color: #B6854D;
}
</style>
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE, 
                      cache.lazy = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
```

```{r,echo=FALSE, eval=FALSE}
rm(list = ls())
```

```{r, echo = FALSE, results=FALSE}
# Paquetes que se usaron en el documento 
require(dplyr)          #A Grammar of Data Manipulation 
require(ggplot2)        # Generar gráficos ggplot y la geometría de un mapa
require(RColorBrewer)
require(ggspatial)
require(ggpubr)
require(knitr)
require(kableExtra)
require(openxlsx)
require(readxl)
require(rgdal)          #Para importar shapefiles. 
require(sp)             # Classes and Methos for Spatial Data
library(spdep)    # Índice de Moran 
require(spdplyr)        #Data manipulation verbs for the sptial classes
require(stringr)
require(tidyverse) 
require(unikn)          # Paleta de colores
```

```{r, echo = FALSE, results=FALSE}
# Se descargan las fuentes de la google fonts
require(showtext)
# activar showtext
showtext_auto()
font_add_google("Montserrat", "montserrat")
```

```{r, echo = FALSE, fig.height=4, fig.width=6, fig.align='center'}
require(ggplot2)
require(ggpubr)
v <- ggplot(faithfuld, aes(waiting, eruptions, z = density)) + 
      geom_contour(aes(colour = after_stat(level)), binwidth = 0.001) +
       theme_transparent() + 
        theme(legend.position = 'none') + 
         scale_color_viridis_c()

v
```


## Objetivo  

Los contornos de una estimación de densidad en 2D son una herramienta fundamental para la visualización estadística, permitiendo representar gráficamente la distribución de variables bidimensionales en un espacio de coordenadas. 

Su principal función consiste en mostrar la concentración de puntos en conjuntos de datos bidimensionales, lo que resulta particularmente útil cuando se trabaja con grandes volúmenes de información. Estos contornos facilitan la identificación de áreas con mayor densidad de observaciones en gráficos de dispersión, solucionando el problema de visualización que surge cuando hay numerosos puntos solapados. 

Además de visualizar distribuciones, estos contornos permiten detectar patrones y estructuras subyacentes en los datos, revelando agrupaciones naturales y la forma general de la distribución, ya sea unimodal, multimodal o con otras características distintivas. Una ventaja adicional es su capacidad para facilitar la comparación entre diferentes subconjuntos de datos, permitiendo superponer contornos en gráficos para analizar diferencias entre distintos grupos o categorías. 

Finalmente, los contornos de estimación de densidad mejoran significativamente la interpretación de datos en gráficos de dispersión tradicionales, especialmente en situaciones donde la alta densidad de puntos dificulta la visualización clara de patrones, ofreciendo una representación más limpia y comprensible de la densidad sin necesidad de mostrar cada punto individual del conjunto de datos. 

## Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública (`SESNSP`)   

El Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública ([`SESNSP`](https://www.gob.mx/sesnsp)) es una institución clave en México, encargada de coordinar y ejecutar las políticas públicas en materia de seguridad pública. Su objetivo principal es fortalecer la seguridad en todo el país, trabajando en colaboración con los tres niveles de gobierno (federal, estatal y municipal).

Las funciones más importantes del `SESNSP`:

* **Coordinación y seguimiento:**
    * El SESNSP actúa como eje de coordinación entre las diversas instituciones de seguridad pública, tanto a nivel federal como estatal y municipal.
    * Da seguimiento a los acuerdos y decisiones del Consejo Nacional de Seguridad Pública.
* **Implementación de políticas públicas:**
    * Se encarga de diseñar e implementar estrategias y programas para prevenir el delito, fortalecer las instituciones de seguridad y mejorar la respuesta ante situaciones de emergencia.
* **Profesionalización y equipamiento:**
    * Promueve la capacitación y profesionalización de los cuerpos de seguridad.
    * Impulsa la modernización del equipamiento tecnológico e infraestructura de las instituciones de seguridad.
* **Información y datos:**
    * Genera y difunde información estadística sobre incidencia delictiva y otros indicadores relevantes para la seguridad pública.
    * Proporciona datos para la toma de decisiones en materia de seguridad.
* **Prevención del delito:**
    * Promueve la cultura de la paz y la legalidad.
    * Desarrolla programas para la prevención social de la violencia y la delincuencia.
* **Participación ciudadana:**
    * Fomenta la colaboración entre la ciudadanía y las autoridades en materia de seguridad.


### Fuentes de información    

El Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública (SESNSP) recopila y publica información sobre incidencia delictiva a través de un proceso sistemático y riguroso que involucra a diversas fuentes oficiales y metodologías estadísticas estandarizadas. Esta institución gubernamental se encarga de centralizar, procesar y difundir los datos relacionados con la seguridad pública en todo el territorio mexicano, proporcionando así una visión integral de la situación delictiva en el país. Aquí te explico detalladamente cómo llevan a cabo este importante proceso de recolección y publicación de información:

- **Fiscalías y Procuradurías:**
    - Las fiscalías generales de los estados y la Fiscalía General de la República (FGR) proporcionan los datos detallados y sistemáticos sobre los delitos registrados en sus investigaciones, constituyendo una de las principales fuentes de información estadística a nivel nacional.
    - Esta información abarca tanto las averiguaciones previas del sistema tradicional como las carpetas de investigación iniciadas bajo el nuevo sistema de justicia penal acusatorio, lo que permite una visión completa del panorama delictivo documentado oficialmente.
- **Registros administrativos:**
    - El SESNSP también utiliza y analiza datos provenientes de diversos registros administrativos de otras instituciones gubernamentales, como las corporaciones policiales estatales y municipales, así como los centros de atención de llamadas de emergencia (911), que complementan la información obtenida de las fiscalías para ofrecer un panorama más integral de la situación delictiva. 
    
    
### Metodología:   

- **Registro de delitos:**
    - La incidencia delictiva se refiere específicamente a la presunta ocurrencia de delitos formalmente registrados en las investigaciones oficiales, siguiendo protocolos estandarizados que permiten la comparabilidad de los datos a nivel nacional e internacional.
    - El SESNSP clasifica meticulosamente los delitos en diferentes categorías y subcategorías, tanto del fuero común como del fuero federal, utilizando criterios uniformes que facilitan el análisis estadístico y la identificación de patrones delictivos en diferentes regiones del país. 
    
    
- **Publicación de datos:**
    - El SESNSP publica periódicamente los datos compilados de incidencia delictiva en su sitio web oficial, a través de informes mensuales detallados y compendios anuales que permiten visualizar tendencias y comportamientos delictivos a lo largo del tiempo.
    - También proporciona acceso a bases de datos abiertos en formatos compatibles con diferentes programas estadísticos para que la ciudadanía, investigadores, organizaciones civiles y otras instituciones gubernamentales puedan acceder, descargar y analizar la información de acuerdo con sus necesidades específicas.
    - En su página oficial se pueden encontrar los datos desagregados por estado, municipio y región geográfica, y también se puede consultar información especializada sobre delitos federales y comunes, incluyendo variables como modalidad, tipo de delito, bienes jurídicos afectados y características demográficas generales. 
    
### Tipos de delitos 

La diferencia fundamental está en el bien jurídico protegido: en el fuero común, se protege a los ciudadanos individualmente, salvaguardando sus derechos personales y patrimoniales dentro del ámbito local; en el fuero federal, se protege a la nación como entidad soberana, incluyendo sus instituciones, la seguridad nacional y el orden constitucional.   

Algunos delitos pueden ser del fuero común o federal dependiendo de las circunstancias específicas del caso, como la participación de funcionarios federales, el lugar donde se comete el delito (si ocurre en instalaciones federales), la naturaleza transnacional del mismo, o si afecta bienes o recursos que son propiedad o están bajo administración federal.   

**Delitos del Fuero Común:**: Son aquellos que afectan directamente a los ciudadanos en su vida cotidiana. Están tipificados en los códigos penales de cada estado.   

- **Ejemplos**:
    - Robo (a casa habitación, a transeúntes, de vehículos)
    - Homicidio
    - Lesiones
    - Violencia familiar
    - Delitos sexuales
- **Jurisdicción**: Son investigados y juzgados por las autoridades de los estados.

**Delitos del Fuero Federal:**: Son aquellos que afectan a la Federación, es decir, a la nación en su conjunto. Están tipificados en el Código Penal Federal y otras leyes federales.  

- **Ejemplos**:
    - Delitos contra la salud (narcotráfico)
    - Delitos fiscales (evasión de impuestos)
    - Delitos electorales
    - Delitos contra la seguridad de la nación (terrorismo)
    - Delitos cometidos en instalaciones federales.
    - Delitos que involucran a funcionarios federales.    
    
**Jurisdicción**: Son investigados y juzgados por las autoridades federales (Fiscalía General de la República).


```{r, eval = FALSE}
df <- read.csv(file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.csv"), 
               header = TRUE,
               encoding = "latin1") %>% 
       rename("CVE_ENT" = "Clave_Ent",
              "CVE_MUN" = "Cve..Municipio") %>%
       mutate(CVE_ENT = str_pad(.$CVE_ENT, width = 2, side = "left", pad = "0"),
              CVE_MUN = str_pad(.$CVE_MUN, width = 5, side = "left", pad = "0"))

```



```{r, echo = FALSE}
#save(df, file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.RData"))
load(file = paste0(here::here(), "/Bases/Municipal-Delitos-2015-2025_ene2025.RData"))
```

```{r, echo = FALSE}
require(gt)

head(df, 10) %>% 
 gt() %>%
  tab_header(title = "Reportes de incidencia delictiva a nivel municipal",
             subtitle = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
       cols_width(starts_with("Bien.jurídico.afectado") ~ px(180),
                  starts_with("Modalidad") ~ px(180),
                  everything() ~ px(100)) %>%
          as_raw_html()
```

<br>


Se suman las columnas de enero hasta diciembre para tener los totales por los diferentes bienes juridicos, tipo de delito, subtipo y modalidad a nivel municipal.  

Por otro lado para fines practicos, se va a trabajar con el año 2024. Para analizar la distribución de los datos de manera espacial. 

```{r}
df <- df %>% 
         mutate(Total = rowSums(.[,10:21], na.rm = TRUE)) %>% 
          filter(Año %in% "2024")
```

Analicemos como se conforma la base de datos 

**Bien jurídico afectado**  

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Bien.jurídico.afectado) %>% 
           summarise(Total = sum(Total, na.rm = TRUE))

tabla %>% 
 gt() %>%
  tab_header(title = "Bien jurídico afectado",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jurídico.afectado") ~ px(280),
                 starts_with("Modalidad") ~ px(320),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Bien.jurídico.afectado = md("**Bien jurídico afectado**")) %>% 
          as_raw_html()
```


**Tipo de delito**   

Se muestran las primeras 10 categorías y de mayor denominación de la categoría **tipo de delito**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Tipo.de.delito) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Tipo de delito",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jurídico.afectado") ~ px(200),
                 starts_with("Tipo.") ~ px(380),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Tipo.de.delito = md("**Tipo de delito**")) %>% 
          as_raw_html()
```

**Subtipo de delito**  

Se muestran las primeras 10 categorías y de mayor denominación de la categoría **subtipo de delito**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Subtipo.de.delito) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Subtipo de delito",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jurídico.afectado") ~ px(200),
                 starts_with("Subtipo.") ~ px(420),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Subtipo.de.delito = md("**Subtipo de delito**")) %>% 
          as_raw_html()
```


**Modalidad**  

Se muestran las primeras 10 categorías y de mayor denominación de la categoría **modalidad**, dentro de la base de incidencias delictivas. 

```{r, echo = FALSE}
tabla <- df %>% 
          group_by(Modalidad) %>% 
           summarise(Total = sum(Total, na.rm = TRUE)) %>% 
            arrange(desc(Total))

head(tabla, 10) %>% 
 gt() %>%
  tab_header(title = "Modalidad",
             subtitle = "SESNSP") %>%
   tab_footnote(footnote = "Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública | 20 de febrero de 2025") %>%
   tab_options(heading.title.font.size = 14, 
               heading.subtitle.font.size = 12,
               table.font.names = "Century Gothic",
               table.font.size = 10,
               table.align = 'center',
               data_row.padding = px(1)) %>%
    tab_style(style = list(cell_text(align = "left", 
                                     weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
     tab_style(style = list(cell_text(align = "left")),
               locations = list(cells_title(groups = c("subtitle")))) %>%
      cols_width(starts_with("Bien.jurídico.afectado") ~ px(200),
                 starts_with("Modalidad") ~ px(420),
                 everything() ~ px(100)) %>%
       fmt_integer(columns = c("Total"),
                   sep_mark = " ") %>% 
        cols_label(Total = md("**Total (2024)**"),
                   Modalidad = md("**Modalidad**")) %>% 
          as_raw_html()
```


## Homicidios dolososos    

Un homicidio doloso se define como la privación de la vida de una persona, donde existe la intención deliberada de causar la muerte. 

Para obtener información más precisa y actualizada, te recomiendo consultar las siguientes fuentes:
  
* Página oficial del [SESNSP](https://www.gob.mx/sesnsp/acciones-y-programas/datos-abiertos-de-incidencia-delictiva?state=published).
* Informes del [INEGI](https://www.inegi.org.mx/temas/mortalidad/).  


```{r}
homicidios <- df %>% 
               filter(Tipo.de.delito %in% "Homicidio")  %>% 
                group_by(CVE_MUN) %>% 
                 summarise(Total = sum(Total, na.rm = TRUE))
```


## Marco Geoestadístico Nacional (MGN) 2020

El **Marco Geoestadístico Nacional (MGN) 2020** del **Instituto Nacional de Estadística y Geografía (INEGI)** es un sistema de referencia geográfica que define la división territorial de México para la recopilación, análisis y presentación de información estadística. Se utiliza principalmente en censos y encuestas para garantizar la compatibilidad de datos espaciales a nivel nacional.

#### **Características principales del MGN 2020:**

1.  **Unidades geográficas:**
    -   **Áreas Geoestadísticas Estatales (AGEE):** corresponden a los estados.\
    -   **Áreas Geoestadísticas Municipales (AGEM):** coinciden con los municipios.\
    -   **Áreas Geoestadísticas Básicas (AGEB):** subdivisiones de los municipios, utilizadas en zonas urbanas y rurales.\
    -   **Manzanas geoestadísticas:** delimitaciones dentro de las AGEB urbanas.
2.  **Proyección y sistema de coordenadas:**
    -   Utiliza el **Sistema de Referencia Geodésico ITRF2008** en coordenadas geográficas con el **datum WGS84**.\
    -   Se presenta en formato vectorial compatible con SIG (Sistemas de Información Geográfica), en formatos como **Shapefile (SHP)** y **GeoJSON**.

#### Shapefile

La función `readOGR` del paquete `rgdal`, extrae automáticamente la información utilizada por otros paquetes `SIG` de código abierto como QGIS y permite a R manejar una gama más amplia de formatos de datos espaciales. Esta función lee datos `OGR` y datos vectoriales, pero solamente permite manejar capas con características geométricas (no mezcla puntos, líneas o polígonos en una sola capa) y a su vez establecerá un sistema de referencia espacial si la capa tiene dichos metadatos.\
Para leer un archivo `shapefile`, se establecen los siguientes argumentos, como `dsn`, en donde se indica el directorio que contiene los shapes y `layer` que es el nombre explícito de la capa a trabajar y dichas capas deben de ir sin la extensión `.shp`.

A continuación, se lee el archivo .shp que contiene de manera integrada la división de el área geoestadística municipal `agem`.

```{r,results=FALSE,class.source = "fold-show"}
shape_estados <- readOGR(dsn ="D:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                             layer = "00ent",
                              encoding = "UTF-8",
                               use_iconv = TRUE)
```

```{r,results=FALSE,class.source = "fold-show"}
shape_municipios <- readOGR(dsn ="D:/MGN/MGN 2020/MGN 2020/conjunto_de_datos", 
                             layer = "00mun",
                              encoding = "UTF-8",
                               use_iconv = TRUE)
```

La función `rename()` del paquete `dplyr` permite cambiar el nombre de la columna de la clave geoestadística a nivel estatal dentro de la base de datos del shape.

```{r,class.source = "fold-show"}
shape_municipios@data <- shape_municipios@data %>%
                          rename("CVE_GEO" = "CVEGEO")
```


### SpatialPolygonsData Frame 

Se fusionan los datos del `shape_municipios` con datos estadísticos del índice de marginación a nivel municipal (`IMM_2020`), excluyendo las claves municipales (`CVE_MUN`) y asegurando que `GM_2020` se ordene de acuerdo a los grados de marginación. El resultado es `layer_municipios`, un objeto que contiene a los municipios junto con sus atributos actualizados, lo que facilita su análisis y visualización en mapas.

#### $$SpatialPolygons \Rightarrow SpatialPolygons + Datos$$

```{r, class.source = "fold-show"}
layer_municipios <- inner_join(shape_municipios,
                                homicidios,
                                 by = join_by("CVE_GEO" == "CVE_MUN"))
```

## Centroides

La función `coordinates()` extrae las coordenadas de los centroides de los polígonos en $(x,y)$ de la base de datos espacial y la almacenamos en la variable `coords`, para su posterior uso en el código.

```{r}
# Extrayendo coordenadas desde la base de datos espaciales.
coords = coordinates(layer_municipios) %>% 
          as.data.frame() %>% 
           rename("lon" = "V1",
                  "lat" = "V2") %>% 
            cbind(layer_municipios@data[, c("CVE_GEO", "CVE_ENT", "Total")])  
```

```{r}
homicidios <- df %>% 
               filter(Subtipo.de.delito %in% "Homicidio doloso") %>% 
                select(CVE_MUN) %>% 
                 left_join(., coords, by = join_by("CVE_MUN" == "CVE_GEO")) %>% 
                  arrange(CVE_MUN) %>% 
                   filter(Total > 0)
```


## Mapa de homicidios  

```{r}
p <- ggplot() + 
      layer_spatial(layer_municipios, aes(fill = Total), color = "transparent") + 
       layer_spatial(shape_estados, fill = "transparent", color = "black") + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          scale_fill_viridis_c(option = "A", begin = 0.3, end = 1, direction = -1) +
           scale_color_manual(values = c("#BDBDBD")) + 
            guides(color = guide_legend(override.aes = list(fill = usecol(pal = pal_petrol, n = 5)))) +
     labs(title = "Mapa coroplético de homicidios dolosos a nivel municipal",
           fill = stringr::str_wrap("Homicidios dolosos", 10), 
            caption = expression(paste("Elaboración propia")))
p
```

## 2D Density Map   

```{r}
p <- ggplot() + 
      layer_spatial(shape_estados, fill = "transparent", color = "black") + 
       geom_point(data = coords, aes(x = lon, y = lat, size = Total, color = Total), alpha = 0.6, shape = 21) +
        #stat_density_2d_filled(data = coords, aes(x = lon, y = lat, fill = ..Total..), alpha = 0.6) + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          guides(size = FALSE, alpha = FALSE) + 
          scale_fill_gradientn(colours = rev(brewer.pal(7, "Spectral"))) + 
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral")))

p
```

```{r}
homicidios <- coords %>% 
               filter(Total > 0) %>% 
                uncount(Total)
```


```{r}
values <- colorRampPalette(c("white", "orange", "red"))(10)

p <- ggplot() + 
      layer_spatial(shape_estados, fill = "transparent", color = "black") + 
        stat_density_2d_filled(data = homicidios, aes(x = lon, y = lat, fill = ..level..), alpha = 0.6) + 
        theme_bw() + 
         theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
               plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
               legend.key.size = unit(0.5, "cm"),
               legend.text = element_text(size = 12, family = "montserrat"), 
               legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
               legend.position = "right"
               ) + 
          guides(size = FALSE, alpha = FALSE) + 
          scale_fill_manual(values = values) + 
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral")))

p
```

```{r}
library(ggplot2)
library(sf)
library(ggspatial)
library(RColorBrewer)

shp_municipios <- st_as_sf(layer_municipios)  

capas_estados <- shape_estados %>%
                  sp::spChFIDs(., str_pad(shape_estados@data$CVEGEO, 2, "left", pad = "0")) %>%
                   fortify(., id = "CVE_GEO")

limites <- capas_estados %>%
            filter(id == c("09", "15", "13")) %>%
             summarise(min.x = min(.$long),
                       max.x = max(.$long),
                       min.y = min(.$lat),
                       max.y = max(.$lat))
 
p <- ggplot() + 
      layer_spatial(shape_municipios, 
                     fill = "transparent", 
                      size = 0.5,
                      color = "#919191") + 
       layer_spatial(shape_estados, 
                      fill = "transparent", 
                       size = 5,
                       color = "black") + 
        geom_point(data = coords, aes(x = lon, y = lat, color = Total, size = Total), alpha = 0.6) +
         stat_density_2d_filled(data = homicidios %>%
                                 filter(CVE_ENT == c("09", "15", "13")), aes(x = lon, y = lat, fill = ..level..), color = "#919191", alpha = 0.6) + 
          theme_bw() + 
           theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
                 plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
                 legend.key.size = unit(0.5, "cm"),
                 legend.text = element_text(size = 12, family = "montserrat"), 
                 legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
                 legend.position = "right"
                 ) + 
          guides(alpha = FALSE, fill = FALSE, color = FALSE) + 
          scale_fill_viridis_d(option = "magma", direction = -1, begin = 0.5, end = 1) +  # Para densidad
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Spectral"))) + 
            coord_sf(xlim = c(limites$min.x, limites$max.x),
                     ylim = c(limites$min.y, limites$max.y)) 

p
```


```{r}
library(ggplot2)
library(sf)
library(ggspatial)
library(RColorBrewer) 
tabla <- homicidios %>% 
          filter(CVE_ENT == "32") 



              
shp_municipios <- st_as_sf(layer_municipios)  

capas_estados <- shape_estados %>%
                  sp::spChFIDs(., str_pad(shape_estados@data$CVEGEO, 2, "left", pad = "0")) %>%
                   fortify(., id = "CVE_GEO")

limites <- capas_estados %>%
            filter(id == c("32")) %>%
             summarise(min.x = min(.$long),
                       max.x = max(.$long),
                       min.y = min(.$lat),
                       max.y = max(.$lat))
 
p <- ggplot() + 
     
         stat_density2d(data = tabla, aes(x = lon, y = lat, fill = stat(level)), geom = "polygon", alpha = 0.4
                        ) + 
   layer_spatial(shape_municipios,
                     fill = "transparent", 
                      size = 0.5,
                      color = "#919191") + 
      
        geom_point(data = coords, aes(x = lon, y = lat, color = Total, size = Total), alpha = 0.6, shape = 21) +
   layer_spatial(shape_estados, 
                      fill = "transparent", 
                       size = 5,
                        color = "black") + 
         # geom_contour_filled(data = coords %>% filter(CVE_ENT == "09"), aes(x = lon, y = lat, z = Total), color = "black", alpha = 0.5) +
           theme_bw() + 
           theme(plot.title = element_text(size = 22, hjust = 0.15, family = "montserrat", face = "bold"),
                 plot.caption = element_text(size = 11, hjust = 0.2, vjust = 1, family = "montserrat"), 
                 legend.key.size = unit(0.5, "cm"),
                 legend.text = element_text(size = 12, family = "montserrat"), 
                 legend.title = element_text(size = 10, hjust = 0.5, family = "montserrat", face = "bold"),
                 legend.position = "right"
                 ) + 
          guides(alpha = FALSE, fill = FALSE, color = FALSE) + 
          scale_fill_viridis_c(option = "magma", direction = 1, begin = 0.5, end = 1) +  # Para densidad
          scale_colour_gradientn(colours = rev(brewer.pal(7, "Blues"))) + 
            coord_sf(xlim = c(limites$min.x, limites$max.x),
                     ylim = c(limites$min.y, limites$max.y)) 


p

```

## Referencias

Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública. (2025). Inicio. Recuperado de: https://www.gob.mx/sesnsp

## Librerías

**Librerías que se usaron en el trabajo** 

```{r, collapse=FALSE}
sesion_info <- devtools::session_info()
```

```{r, echo = FALSE}
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
   kable_classic(full_width = TRUE, html_font = "montserrat", font_size = 10) 
```

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png" alt="Creative Commons Licence" style="border-width:0"/></a><br />This work by [**Diana Villasana Ocampo**]{xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName"} is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.


